{"version":3,"sources":["khplayer.js"],"names":["KHPlayer","[object Object]","uniqueKey","previewThumbnails","customConfig","Object","assign","configurator","enabled","src","Promise","resolve","Plyr","setup","url","d","document","PLAYLIST_","getJSON","length","UKS","data","PLAYLIST","poster","querySelector","innerHTML","setAttribute","index","currentID","currentVid","list_ep","createElement","appendChild","currentLine","getElementById","title","playingData","localStorage","getItem","plyr","initPlyr","tweaks","playingDataJSON","JSON","parse","confirmi18n","i18n","continueWatchingConfirm","_insertBefore","_1","epIndex","_2","Date","time","toISOString","substr","_3","yes","no","insertAfter","toggleEmbedPlayllist","nextEpisode","previousEpisode","cloneNode","on","event","setItem","removeItem","addEventListener","classList","add","elem","parseInt","getAttribute","parentNode","select_all","querySelectorAll","currLi","forEach","e","removeAttribute","style","color","currData","destroy","currVideoTag","sources","type","toUpperCase","m3u8","tracks","addSubsForLibsPlayer","source","play","next_episode","selectCurrEp","nextElementSibling","click","loopCheckMediaLoaded","setInterval","state","newValue","this","togglePlayerFullScreen","clearInterval","readyState","val","currentPlayingTime","Math","round","currentTime","stringify","place","convertDataToElem","insertBefore","nextSibling","htmlToElement","toggle","nextOrPrev","currEp","nextEp","prevEp","previousElementSibling","episode","tempLoop","status","value","Hls","isSupported","hls","loadSource","attachMedia","Events","MANIFEST_PARSED","reject","request","XMLHttpRequest","open","onreadystatechange","responseText","Error","send","tempSub","label","srclang","html","template","trim","content","firstChild","jsonPaths","currentScript","defaultQuality","seekTime","invertTime","captions","active","language","update","tooltips","controls","seek","restart","rewind","pause","fastForward","seekLabel","played","buffered","duration","volume","mute","unmute","enableCaptions","disableCaptions","download","enterFullscreen","exitFullscreen","frameTitle","settings","pip","menuBack","speed","normal","quality","loop","start","end","all","reset","disabled","advertisement","qualityBadge","2160","1440","1080","720","576","480","init"],"mappings":"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","sourcesContent":["/*\r\nNOTE: concept:\r\n\r\nĐầu tiên client add Plyr.js và khplayer.js. Ở tag của khplayer.js kèm theo 1 attribute jsonPath, value là 1 array (tất nhiên là kiểu string, sau khi đem vào đây thì JSON.parse ra), đồng thời phải nhét thêm defer vào nếu đặt trước cặp thẻ <div> container của từng playlist player\r\n\r\nArray chứa đường dẫn tới file JSON chứa dữ liệu của 1 tập hợp các video như: URL, phụ đề, tiêu đề, độ phân giải, poster, abcxyz... Mình gọi array trong file JSON này là Array mẹ (để dễ ghi chú ở dưới)\r\n\r\nElement cuối của Array mẹ là một uniqueKey, đồng thời là ID của thẻ container nói ở ý đầu tiên. Ngay trước element này là URL dẫn tới poster chính của player\r\n*/\r\n// jshint esversion: 9\r\n\r\nconst KHPlayer = {\r\n  // Khởi tạo Plyr\r\n  initPlyr(uniqueKey, previewThumbnails = false) {\r\n    // Phải nói ở chỗ này mình khôn vl ra. Clone config vào customConfig từ KHPlayer, check trong dữ liệu của tập được init trong JSON có previewThumbnails hay không thì edit customConfig để enable lên, đồng thời thêm source vào.\r\n    let customConfig = Object.assign({}, KHPlayer.configurator);\r\n    if (previewThumbnails) customConfig.previewThumbnails = {\r\n      enabled: true,\r\n      src: previewThumbnails.src\r\n    };\r\n    return new Promise(function (resolve) {\r\n      resolve(Plyr.setup(\"#\" + uniqueKey + \" video\", customConfig));\r\n    });\r\n  },\r\n\r\n  // Khởi tạo KHPlayer ở đây\r\n  // NOTE: chính bởi vì ở func đổi tập, mình lựa chọn cách destroy cái cũ đi và init lại cái mới, những eventListener đối với player cũ (để Plyr tương tác) cũng sẽ bị destroy theo. Vì vậy hãy add listener vào trong func đổi tập (ví dụ như cái auto next tập chẳng hạn)\r\n  async init(url) {\r\n\r\n    /* NOTE: Mỗi playlist (Array mẹ), mỗi Container (cái mà client paste vào HTML), mỗi cái player (thực chất là 1 object) để Plyr tương tác đều được gán uniqueKey (là key, ID) để có thể có nhiều player mà không bị conflict lẫn nhau */\r\n    let\r\n      d = document,\r\n      // Lấy tạm dữ liệu về PLAYLIST_\r\n      PLAYLIST_ = await KHPlayer.getJSON(url),\r\n      // Lấy uniqueKey từ PLAYLIST_\r\n      uniqueKey = await PLAYLIST_[PLAYLIST_.length - 1],\r\n      UKS = \"#\" + uniqueKey;\r\n    // Gán data đã lấy từ trước trong PLAYLIST_ vào KHPLayer.data[uniqueKey]\r\n    KHPlayer.data[uniqueKey] = PLAYLIST_;\r\n    // Gọi dữ liệu vào đây để syntax ngắn hơn\r\n    PLAYLIST = KHPlayer.data[uniqueKey];\r\n\r\n    let\r\n      // elem sát cuối là url poster tổng\r\n      poster = await PLAYLIST[PLAYLIST.length - 2];\r\n    // Cái này vì mình dùng jQuery nên gắn # vào cho nhanh\r\n\r\n    // Tạo 1 cái frame bên trong container player\r\n    d.querySelector(UKS).innerHTML = `\r\n        <video control playsinline></video>\r\n        <ul key=\"${uniqueKey}\" class='KHPPlaylistContainer'></ul>`;\r\n    // Set poster\r\n    d.querySelector(UKS + \" video\").setAttribute(\"poster\", poster);\r\n\r\n    // Khởi tạo playlist\r\n    // Cái này để check playlist có trống hay không, mà hình như có vẻ thừa thãi :)))\r\n    if (PLAYLIST.length > 0) {\r\n      // Để index bắt đầu từ 0\r\n      let index = 0;\r\n      // Biến Array mẹ thành GUI, một list chứa các episode\r\n      while (index <= PLAYLIST.length - 3) {\r\n        let\r\n          // Tạo id cho từ mục một\r\n          currentID = +index,\r\n          // Gọi data của từng elem trong array \"tổng\" xuống\r\n          currentVid = PLAYLIST[index],\r\n          // Giờ mới create elem\r\n          list_ep = d.createElement(\"li\");\r\n        list_ep.setAttribute(\"index\", currentID);\r\n        // Append mục chọn tập vào container\r\n        d.querySelector(`#${uniqueKey} .KHPPlaylistContainer`).appendChild(list_ep); //jshint ignore:line\r\n        // Gọi mục chọn tập lên\r\n        let currentLine = d.getElementById(uniqueKey).querySelector(\"li[index='\" + currentID + \"'\");\r\n        // Gán cho nó cái nội dung (gọi title từ currentVid lên array tổng xuống)\r\n        currentLine.innerHTML = currentVid.title;\r\n        // function đổi tập\r\n        currentLine.setAttribute(\"onclick\", `KHPlayer.changeEp(this)`);\r\n        // Tăng index ở phía trên lên 1, tiếp tục cho mục chọn tiếp theo\r\n        index++;\r\n      }\r\n    }\r\n\r\n    let playingData = localStorage.getItem(\"playing_\" + uniqueKey);\r\n\r\n\r\n    // NOTE: Plyr đc khởi tạo ở chỗ này\r\n    KHPlayer.plyr[uniqueKey] = await KHPlayer.initPlyr(uniqueKey);\r\n\r\n    // Cái này chỉ được chạy đúng lần cho đến khi người dùng chọn tập\r\n    // KHPlayer.plyr[uniqueKey][0].on(\"play\", function () {\r\n\r\n    // });\r\n    KHPlayer.tweaks(uniqueKey);\r\n\r\n    if (playingData != null) {\r\n      let playingDataJSON = JSON.parse(playingData),\r\n        confirmi18n = KHPlayer.configurator.i18n.continueWatchingConfirm;\r\n      // Source: https://stackoverflow.com/a/25279340\r\n      KHPlayer._insertBefore(\r\n        UKS + ' .plyr__video-wrapper video',\r\n        `<div class=\"systemDetectHistory\">\r\n          <div class=\"text\">${confirmi18n._1} ${KHPlayer.data[uniqueKey][playingDataJSON.epIndex].title} ${confirmi18n._2} ${new Date(playingDataJSON.time * 1000).toISOString().substr(11, 8)}<br>${confirmi18n._3}</div>\r\n          <div class=\"actions\">\r\n            <div class=\"confirmBtn\">\r\n              <div onclick='KHPlayer.acceptContinue(\"${uniqueKey}\", ${playingDataJSON.epIndex}, ${playingDataJSON.time})' class=\"buttonInner\">${confirmi18n.yes}</div>\r\n            </div>\r\n            <div class=\"confirmBtn\">\r\n              <div onclick='document.querySelector(\"#${uniqueKey} .systemDetectHistory\").classList.add(\"hideAlert\")' class=\"buttonInner\">${confirmi18n.no}</div>\r\n            </div>\r\n          </div>\r\n        </div>`,\r\n        true\r\n      );\r\n    }\r\n  },\r\n\r\n  // Khởi chạy mỗi Plyr được khởi tạo lại, hay mỗi lần đổi tập bởi cái destroy() rồi init lại trong cáo changeEp, lý do vì sao cũng đã giải thích ở dới đó\r\n  tweaks(uniqueKey) {\r\n    let\r\n      // Lát nữa gọi document cho dễ\r\n      d = document,\r\n      UKS = \"#\" + uniqueKey;\r\n\r\n    //#region Thêm vài nút chức năng vào player\r\n    // Nút ẩn/hiện embed playlistCtn\r\n    // <i class=\"fas fa-bars fa-lg\"></i>\r\n    KHPlayer.insertAfter(\r\n      UKS + \" .plyr__controls>.plyr__menu\",\r\n      `<button class=\"plyr__controls__item plyr__control customBtn\" type=\"button\" onclick=\"KHPlayer.togglePlaylist('${uniqueKey}')\">\r\n      <svg aria-hidden=\"true\" focusable=\"false\" data-prefix=\"fas\" data-icon=\"list-ul\" class=\"svg-inline--fa fa-list-ul fa-w-16\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 512 512\"><path fill=\"currentColor\" d=\"M48 48a48 48 0 1 0 48 48 48 48 0 0 0-48-48zm0 160a48 48 0 1 0 48 48 48 48 0 0 0-48-48zm0 160a48 48 0 1 0 48 48 48 48 0 0 0-48-48zm448 16H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zm0-320H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16V80a16 16 0 0 0-16-16zm0 160H176a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16z\"></path></svg>\r\n      <span class=\"plyr__tooltip\">${KHPlayer.configurator.i18n.toggleEmbedPlayllist}</span>\r\n      </button>`,\r\n      true\r\n    );\r\n    // Nút next tập\r\n    // next/prevEpBtn để responsive, hide đi khi width <= 500px\r\n    // <i class=\"fas fa-step-forward fa-lg\"></i>\r\n    KHPlayer.insertAfter(\r\n      UKS + \" .plyr__controls > button:nth-child(1)\",\r\n      `<button class=\"plyr__controls__item plyr__control customBtn nextEpBtn\" type=\"button\" onclick=\"KHPlayer.navigateEp(this,'next')\">\r\n      <svg aria-hidden=\"true\" focusable=\"false\" data-prefix=\"fas\" data-icon=\"step-forward\" class=\"svg-inline--fa fa-step-forward fa-w-14\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 448 512\"><path fill=\"currentColor\" d=\"M384 44v424c0 6.6-5.4 12-12 12h-48c-6.6 0-12-5.4-12-12V291.6l-195.5 181C95.9 489.7 64 475.4 64 448V64c0-27.4 31.9-41.7 52.5-24.6L312 219.3V44c0-6.6 5.4-12 12-12h48c6.6 0 12 5.4 12 12z\"></path></svg>\r\n      <span class=\"plyr__tooltip\">${KHPlayer.configurator.i18n.nextEpisode}</span>\r\n      </button>`,\r\n      true\r\n    );\r\n    // Nút previous tập\r\n    // <i class=\"fas fa-step-backward fa-lg\"></i>\r\n    KHPlayer._insertBefore(\r\n      UKS + \" .plyr__controls > button:nth-child(1)\",\r\n      `<button class=\"plyr__controls__item plyr__control customBtn prevEpBtn\" type=\"button\" onclick=\"KHPlayer.navigateEp(this,'prev')\">\r\n      <svg aria-hidden=\"true\" focusable=\"false\" data-prefix=\"fas\" data-icon=\"step-backward\" class=\"svg-inline--fa fa-step-backward fa-w-14\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 448 512\"><path fill=\"currentColor\" d=\"M64 468V44c0-6.6 5.4-12 12-12h48c6.6 0 12 5.4 12 12v176.4l195.5-181C352.1 22.3 384 36.6 384 64v384c0 27.4-31.9 41.7-52.5 24.6L136 292.7V468c0 6.6-5.4 12-12 12H76c-6.6 0-12-5.4-12-12z\"></path></svg>\r\n      <span class=\"plyr__tooltip\">${KHPlayer.configurator.i18n.previousEpisode}</span>\r\n      </button>`,\r\n      true\r\n    );\r\n    //#endregion\r\n\r\n    //#region Thêm KHPPlaylistContainer vào trong container chứa <video> (để overlay)\r\n    /* Source:\r\n      https://stackoverflow.com/a/18602389\r\n      https://www.w3schools.com/jsref/met_node_clonenode.asp\r\n    */\r\n    KHPlayer._insertBefore(\r\n      UKS + ' .plyr__video-wrapper video',\r\n      d.querySelector(`.KHPPlaylistContainer[key='${uniqueKey}']`).cloneNode(true)\r\n    );\r\n    d.querySelector(UKS + \" .plyr__video-wrapper .KHPPlaylistContainer\").setAttribute(\"class\", \"EmbedKHPPlaylist hideEmbedKHPPlaylist\");\r\n    //#endregion\r\n\r\n    //#region Gán trạng thái player vào localStorage (đang fullscreen hay bình thường) để khi chuyển sang tập khác sẽ auto fullscreen lại hay không\r\n    // Source: https://www.w3schools.com/jsref/prop_win_localstorage.asp\r\n    KHPlayer.plyr[uniqueKey][0].on(\"enterfullscreen\", event => {\r\n      localStorage.setItem(\"IsFullScreen_\" + uniqueKey, \"yes\");\r\n    });\r\n    KHPlayer.plyr[uniqueKey][0].on(\"exitfullscreen\", event => {\r\n      localStorage.removeItem(\"IsFullScreen_\" + uniqueKey);\r\n    });\r\n    if (!d.querySelector(UKS + \" .EmbedKHPPlaylist\")) {\r\n      d.querySelector(UKS + \" .plyr__video-wrapper\").addEventListener(\"click\", () => {\r\n        d.querySelector(UKS + \" .EmbedKHPPlaylist\").classList.add(\"hideEmbedKHPPlaylist\");\r\n      });\r\n    }\r\n  },\r\n  // Function đổi tập. Thay vì loop epindex như trước, gây một vài vấn đề về tương thích, mình gán luôn function vào mỗi <li> trong DOM, kèm theo this\r\n  async changeEp(elem) {\r\n    // Lấy index của tập từ attribute \"index\" luôn\r\n\r\n    let d = document,\r\n      index = parseInt(elem.getAttribute('index'), 10),\r\n      // Lấy uniqueKey từ <ul> đã nhồi nhét sẵn\r\n      uniqueKey = await elem.parentNode.getAttribute(\"key\"),\r\n      // Viết tắt của uniqueKeySelector\r\n      UKS = \"#\" + uniqueKey;\r\n\r\n    // Làm <li> của tập đang được phát nổi bật lên\r\n    // Chọn toàn bộ các <li> trong <ul> danh sách tập\r\n    select_all = d.querySelector(UKS + \" .KHPPlaylistContainer\").querySelectorAll(\"li\");\r\n    let currLi = d.querySelector(`${UKS} .KHPPlaylistContainer li[index='${index}']`);\r\n    // Xoá style (làm nổi bật <li> hiện đang phát) và indicator cái trước\r\n    select_all.forEach(function (e) {\r\n      e.removeAttribute(\"playing\");\r\n      e.removeAttribute(\"style\");\r\n    });\r\n    // Sau đó add lại cho cái cái vừa click\r\n    currLi.style.color = \"yellow\";\r\n    currLi.setAttribute(\"playing\", \"true\");\r\n\r\n    // Dữ liệu episode cần init\r\n    let currData = KHPlayer.data[uniqueKey][index];\r\n\r\n    // Thường thì chỉ cần .source thôi là đủ (để chuyển tập), nhưng khi sử dụng nguồn m3u8, phải sử dụng API của HLS, source HLS mới chồng chéo lên source Plyr cũ. Cách giải quyết là destroy luôn cái cũ đi rồi init cái mới\r\n    KHPlayer.plyr[uniqueKey][0].destroy();\r\n    KHPlayer.plyr[uniqueKey] = await KHPlayer.initPlyr(uniqueKey, currData.previewThumbnails);\r\n\r\n    let currVideoTag = d.querySelector(UKS + \" video\"),\r\n      currMediaType = currData.sources[0].type;\r\n\r\n    // Handle phần source đưa vào player. Nếu là M3U8 thì sử dụng HLS để thêm source, đồng thời thêm captions (nếu có)\r\n    if (currMediaType.toUpperCase() === \"M3U8\") {\r\n      KHPlayer.m3u8(currVideoTag, currData.sources[0].src);\r\n      if (currData.tracks != void 0) {\r\n        KHPlayer.addSubsForLibsPlayer(UKS + \" video\", currData.tracks[0]);\r\n      }\r\n      // Còn không thì dùng luôn API của Plyr, khỏi cần thêm cái addCaptions như trên\r\n    } else {\r\n      KHPlayer.plyr[uniqueKey][0].source = await currData;\r\n      await KHPlayer.plyr[uniqueKey][0].play();\r\n    }\r\n\r\n    // Tự động next khi hết tập\r\n    // Đầu tiên đặt cái on(\"ended\") (theo API của Plyr)\r\n    KHPlayer.plyr[uniqueKey][0].on('ended', function () {\r\n      // Lấy tập đang phát dựa vào cái indicator đã thêm ở trên > select tập tiếp theo > nếu tồn tại (!= void 0) thì click vào đó.\r\n      // Về vụ nextElementSubling hay nextSibling: https://stackoverflow.com/a/24226603\r\n      let current_episode = KHPlayer.selectCurrEp(uniqueKey),\r\n        next_episode = current_episode.nextElementSibling;\r\n      if (next_episode != void 0) {\r\n        // Source: https://www.w3schools.com/jsref/met_html_click.asp\r\n        next_episode.click();\r\n      }\r\n    });\r\n\r\n    if (localStorage.getItem(\"IsFullScreen_\" + uniqueKey) === \"yes\") {\r\n      let loopCheckMediaLoaded = setInterval(() => {\r\n        // Giải thích sơ sơ nó là như thế này: hàm newValue khi được nhận dữ liệu nó sẽ chạy hàm set, ví dụ như ở dưới. Còn khi được request dữ liệu thì nó chạy hàm get, ví dụ console.log(watchVar.newValue). Cho nên trong trường hợp dưới đây, phần get newValue hoàn toàn thừa thãi bởi mình chỉ tận dụng cái tính năng set của nó để \"trông\" cái <video> trên DOM khi nào load xong media thì fullscreen. Có thể trong tương lai mình lại tận dụng được hàm get nên cứ để đấy, đồng thời cho cái jshint đỡ phải gào mồm lên đòi có hàm get :))\r\n        // Source: https://viblo.asia/p/getter-va-setter-trong-javascript-3P0lPOX4Zox\r\n        let watchVar = {\r\n          state: void 0,\r\n          get newValue() {\r\n            return this.state;\r\n          },\r\n          set newValue(newValue) {\r\n            this.state = newValue;\r\n            if (this.state === 4) {\r\n              KHPlayer.togglePlayerFullScreen(uniqueKey);\r\n              clearInterval(loopCheckMediaLoaded);\r\n            }\r\n          }\r\n        };\r\n        watchVar.newValue = d.querySelector(UKS + \" .plyr video\").readyState;\r\n      }, 100);\r\n    }\r\n    // Lưu thời gian video đang xem mỗi 5 giây vào localStorage\r\n    setInterval(() => {\r\n      let watchVideoState = {\r\n        state: void 0,\r\n        get newValue() {\r\n          return this.state;\r\n        },\r\n        set newValue(val) {\r\n          this.state = val;\r\n          if (this.state === 4) {\r\n            let currentPlayingTime = Math.round(KHPlayer.plyr[uniqueKey][0].currentTime);\r\n            localStorage.setItem(\"playing_\" + uniqueKey, JSON.stringify({\r\n              epIndex: index,\r\n              time: currentPlayingTime\r\n            }));\r\n          }\r\n        },\r\n      };\r\n      watchVideoState.newValue = d.querySelector(UKS + \" .plyr video\").readyState;\r\n    }, 1000);\r\n    KHPlayer.tweaks(uniqueKey);\r\n  },\r\n  insertAfter(place, data, convertDataToElem = false) {\r\n    // Source: https://github.com/nefe/You-Dont-Need-jQuery#3.7\r\n    let elem = document.querySelector(place);\r\n    if (convertDataToElem === false) {\r\n      elem.parentNode.insertBefore(data, elem.nextSibling);\r\n    } else if (convertDataToElem === true) {\r\n      elem.parentNode.insertBefore(KHPlayer.htmlToElement(data), elem.nextSibling);\r\n    }\r\n  },\r\n  // Tránh confict với insertBefore của javascript\r\n  _insertBefore(place, data, convertDataToElem = false) {\r\n    let elem = document.querySelector(place);\r\n    if (convertDataToElem === false) {\r\n      elem.parentNode.insertBefore(data, elem);\r\n    } else if (convertDataToElem === true) {\r\n      elem.parentNode.insertBefore(KHPlayer.htmlToElement(data), elem);\r\n    }\r\n  },\r\n  // Ẩn/hiện embed playlist trong <video> container\r\n  togglePlaylist(uniqueKey) {\r\n    /* Source:\r\n      https://www.w3schools.com/howto/howto_js_toggle_class.asp\r\n      https://stackoverflow.com/a/16177700\r\n    */\r\n    document.querySelector(\"#\" + uniqueKey + \" .EmbedKHPPlaylist\").classList.toggle(\"hideEmbedKHPPlaylist\");\r\n  },\r\n  selectCurrEp(uniqueKey) {\r\n    return document.querySelector(`#${uniqueKey} .KHPPlaylistContainer li[playing='true']`);\r\n  },\r\n  navigateEp(elem, nextOrPrev) {\r\n    let uniqueKey = elem.parentNode.parentNode.parentNode.getAttribute(\"id\"),\r\n      currEp = KHPlayer.selectCurrEp(uniqueKey);\r\n    if (currEp === null) document.querySelector(\"#\" + uniqueKey + \" .KHPPlaylistContainer li[index='0']\").click();\r\n    if (currEp !== null) {\r\n      let\r\n        nextEp = currEp.nextElementSibling,\r\n        prevEp = currEp.previousElementSibling;\r\n      if (nextOrPrev === \"next\") {\r\n        if (nextEp !== null) nextEp.click();\r\n      }\r\n      if (nextOrPrev === \"prev\") {\r\n        if (prevEp === null) {\r\n          currEp.click();\r\n        } else {\r\n          prevEp.click();\r\n        }\r\n      }\r\n    }\r\n  },\r\n  togglePlayerFullScreen(uniqueKey) {\r\n    document.querySelector(`#${uniqueKey} button[data-plyr=\"fullscreen\"]`).click();\r\n  },\r\n  acceptContinue(uniqueKey, episode, time) {\r\n    document.querySelector(`#${uniqueKey} .KHPPlaylistContainer li[index=\"${episode}\"]`).click();\r\n    var tempLoop = setInterval(() => {\r\n      let checkMediaStatus = {\r\n        status: void 0,\r\n        get newValue() {\r\n          return this.status;\r\n        },\r\n        set newValue(value) {\r\n          this.status = value;\r\n          if (this.status === 4) {\r\n            KHPlayer.plyr[uniqueKey][0].currentTime = time;\r\n            clearInterval(tempLoop);\r\n          }\r\n        }\r\n      };\r\n      checkMediaStatus.newValue = document.querySelector(`#${uniqueKey} .plyr video`).readyState;\r\n    }, 100);\r\n  },\r\n  // Source: http://youmightnotneedjquery.com/\r\n  m3u8(elem, source) {\r\n    if (Hls.isSupported()) {\r\n      var hls = new Hls();\r\n      hls.loadSource(source);\r\n      hls.attachMedia(elem);\r\n      hls.on(Hls.Events.MANIFEST_PARSED, function () {\r\n        elem.play();\r\n      });\r\n    }\r\n  },\r\n  getJSON(url) {\r\n    return new Promise(function (resolve, reject) {\r\n      var request = new XMLHttpRequest();\r\n      request.open('GET', url, true);\r\n      request.onreadystatechange = function () {\r\n        if (this.readyState === 4) {\r\n          if (this.status >= 200 && this.status < 400) {\r\n            var data = JSON.parse(this.responseText);\r\n            resolve(data);\r\n          } else {\r\n            reject(new Error(\"Double check JSON path/url\"));\r\n          }\r\n        }\r\n      };\r\n      request.send();\r\n      request = null;\r\n    });\r\n  },\r\n  addSubsForLibsPlayer(elem, data) {\r\n    let tempSub = `<track kind=\"subtitles\" label=\"${data.label}\" srclang=\"${data.srclang}\" src=\"${data.src}\">`;\r\n    document.querySelector(elem).appendChild(KHPlayer.htmlToElement(tempSub));\r\n  },\r\n  // Source: https://stackoverflow.com/a/35385518\r\n  htmlToElement(html) {\r\n    var template = document.createElement('template');\r\n    html = html.trim(); // Never return a text node of whitespace as the result\r\n    template.innerHTML = html;\r\n    return template.content.firstChild;\r\n  },\r\n  // loadCSSfromURL() {\r\n  //   // Source: https://developer.mozilla.org/vi/docs/Web/JavaScript/Reference/Functions/arguments\r\n  //   for (let i = 0; i < arguments.length; i++) {\r\n  //     document.getElementsByTagName(\"head\")[0].appendChild(KHPlayer.htmlToElement(`<link rel=\"stylesheet\" href=\"${arguments[i]}\">`))\r\n  //   }\r\n  // },\r\n  // Source: https://developer.mozilla.org/en-US/docs/Web/API/Document/currentScript\r\n  jsonPaths: JSON.parse(document.currentScript.getAttribute(\"jsonPath\")),\r\n  // Chứa dữ liệu từ file json mà người dùng load\r\n  data: {},\r\n  // Các <video> đẻ plyr tương tác\r\n  plyr: {}\r\n};\r\nKHPlayer.jsonPaths.forEach(function (e) {\r\n  // let configData = document.currentScript.getAttribute(\"config\");\r\n  // if (configData) {} else {\r\n  let defaultConfig = {\r\n    defaultQuality: 1080,\r\n    seekTime: 5,\r\n    invertTime: false,\r\n    captions: {\r\n      active: true,\r\n      language: 'auto',\r\n      update: true\r\n    },\r\n    tooltips: {\r\n      controls: true,\r\n      seek: true\r\n    },\r\n    // Vietnamese\r\n    i18n: {\r\n      restart: 'Khởi động lại',\r\n      rewind: 'Tua trước {seektime}s',\r\n      play: 'Phát',\r\n      pause: 'Tạm dừng',\r\n      fastForward: 'Tua tới {seektime}s',\r\n      seek: 'Tua',\r\n      seekLabel: '{currentTime} của {duration}',\r\n      played: 'Đã phát',\r\n      buffered: 'Đã tải trước',\r\n      currentTime: 'Thời gian bây giờ',\r\n      duration: 'Thời lượng',\r\n      volume: 'Âm lượng',\r\n      mute: 'Tắt tiếng',\r\n      unmute: 'Bật tiếng',\r\n      enableCaptions: 'Bật phụ đề',\r\n      disableCaptions: 'Tắt phụ đề',\r\n      download: 'Tải xuống',\r\n      enterFullscreen: 'Toàn màn hình',\r\n      exitFullscreen: 'Thoát toàn màn hình',\r\n      frameTitle: 'Trình phát cho {title}',\r\n      captions: 'Phụ đề',\r\n      settings: 'Cài đặt',\r\n      pip: 'PIP',\r\n      menuBack: 'Quay lại',\r\n      speed: 'Tốc độ',\r\n      normal: 'Bình thường',\r\n      quality: 'Chất lượng',\r\n      loop: 'Lặp',\r\n      start: 'Bắt đầu',\r\n      end: 'Kết thúc',\r\n      all: 'Tất cả',\r\n      reset: 'Khởi động lại',\r\n      disabled: 'Tắt',\r\n      enabled: 'Bật',\r\n      advertisement: 'Quảng cáo',\r\n      qualityBadge: {\r\n        2160: '4K',\r\n        1440: 'HD',\r\n        1080: 'HD',\r\n        720: 'HD',\r\n        576: 'SD',\r\n        480: 'SD',\r\n      },\r\n      nextEpisode: 'Tập tiếp theo',\r\n      previousEpisode: 'Tập trước',\r\n      toggleEmbedPlayllist: 'Danh sách tập',\r\n      continueWatchingConfirm: {\r\n        'yes': 'Có',\r\n        'no': 'Không',\r\n        '_1': 'Hệ thống nhận thấy bạn đã xem đến tập',\r\n        '_2': 'tại',\r\n        '_3': 'Bạn có muốn tiếp tục không?'\r\n      }\r\n    },\r\n    // English\r\n    // _i18n: {\r\n    //   nextEpisode: 'Next episode',\r\n    //   previousEpisode: 'Previous episode',\r\n    //   toggleEmbedPlayllist: 'Toggle playlist',\r\n    //   continueWatchingConfirm: {\r\n    //     'yes': 'Yes',\r\n    //     'no': 'No',\r\n    //     '_1': 'You were watching',\r\n    //     '_2': 'at',\r\n    //     '_3': 'Want to continue?'\r\n    //   }\r\n    // },\r\n  };\r\n  KHPlayer.configurator = defaultConfig;\r\n  // }\r\n  KHPlayer.init(e);\r\n});"],"file":"khplayer.min.js"}